<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - {{ product.name }}</title>
    <style>
      .manage-cell {
        position: relative;
      }
      .delete-icon {
        visibility: hidden;
        color: red;
        cursor: pointer;
      }
      .manage-cell:hover .delete-icon {
        visibility: visible;
      }
      .modal {
        display: none;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        padding: 1rem;
        border: 1px solid #aaa;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
      .modal.show {
        display: block;
      }
      .manage-cell {
        position: relative;
      }
      .edit-icon {
        visibility: visible; /* üõ†Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î */
        cursor: pointer;
        color: #555;
        margin-right: 5px;
      }
      .delete-icon {
        visibility: hidden; /* üóëÔ∏è ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô */
        color: red;
        cursor: pointer;
      }
      .manage-cell:hover .delete-icon {
        visibility: visible; /* üóëÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≠‡∏ô hover */
      }
      .variant-row {
        margin-bottom: 8px;
      }
      .form-section {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 6px;
      }
      input[type="number"] {
        width: 80px;
        padding: 4px;
      }
      textarea {
        width: 300px;
      }
      /* Toggle switch container */
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        margin-right: 10px;
      }
      /* Hide default checkbox */
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      /* Slider */
      .slider {
        position: absolute;
        cursor: pointer;
        background-color: #ccc;
        border-radius: 34px;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        transition: 0.4s;
      }
      
      /* Circle inside */
      .slider::before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: 0.4s;
      }
      
      /* Checked */
      .switch input:checked + .slider {
        background-color: #4caf50;
      }
      .switch input:checked + .slider::before {
        transform: translateX(26px);
      }
    </style>
  </head>
  <body>
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <h1>‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ product.name }}</h1>
    <form method="post" enctype="multipart/form-data">
      <input type="hidden" id="maxSalesVariantRows" value="{{ product.variants | selectattr('is_for_sale') | list | length }}">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ):</label>
      <input type="date" name="date_in" value="{{ current_date }}" required />
      <br />
      <!-- Check box ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å size ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ -->
      <label class="switch">
        <input type="checkbox" id="enableSalesVariants" onchange="toggleSalesVariants()">
        <span class="slider"></span>
      </label>
      <strong>
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
      </strong>
      <div id="sales-variants-section" style="display: none;">
        <div id="sales-variants-container"></div>
        <button type="button" id="add-sales-variant-btn" onclick="addSalesVariant()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</button>
      </div></br>
      <!-- Check box ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö size ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà -->
      <label class="switch">
        <input type="checkbox" id="enableCustomStockin" onchange="toggleCustomStockin()">
        <span class="slider"></span>
      </label>
        <strong>
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        </strong> (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà, ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à):
      <div id="custom-stockin-section" style="display: none;">
        <div id="custom-stockin-wrapper">
          <div class="custom-stockin-entry">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
              <input list="presetVariants" name="custom_variant_name[]" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà">
              <datalist id="presetVariants">
                <option value="‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà">
              </datalist>
            </label>
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢:
              <input type="number" name="custom_variant_pack_size[]" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100,500">
            </label>
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤:
              <input type="number" name="custom_variant_qty[]" min="0" value="0">
            </label>
          </div>
        </div>
      </div>
      <br />
      <label
        >‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á/‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:
        <input type="file" name="evidence" accept="image/*" /></label
      ><br />
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
      <textarea
        name="note"
        rows="3"
        cols="40"
        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ñ‡∏° 2 ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà..."
      ></textarea>
      <br /><br />
      <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </form>
    <br />
    <a href="{{ url_for('index') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <hr />
    <h2>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <table border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤(‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô)</th>
          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
          <th>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
          <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</th>
          <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody> <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        {% for record in history %} 
        <tr>
          <td> <!-- ‡∏ä‡πà‡∏≠‡∏á1 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ -->
            {% if record.date_in %}
              {{ record.date_in.strftime('%d') }} 
              {{ record.date_in.strftime('%b')
                  | replace('Jan','‡∏°.‡∏Ñ.') | replace('Feb','‡∏Å.‡∏û.') |
                    replace('Mar','‡∏°‡∏µ.‡∏Ñ.') | replace('Apr','‡πÄ‡∏°.‡∏¢.') |
                    replace('May','‡∏û.‡∏Ñ.') | replace('Jun','‡∏°‡∏¥.‡∏¢.') |
                    replace('Jul','‡∏Å.‡∏Ñ.') | replace('Aug','‡∏™.‡∏Ñ.') |
                    replace('Sep','‡∏Å.‡∏¢.') | replace('Oct','‡∏ï.‡∏Ñ.') |
                    replace('Nov','‡∏û.‡∏¢.') | replace('Dec','‡∏ò.‡∏Ñ.') 
              }} 
              {{ record.date_in.year + 543 }}
            {% else %}
            <span style="color:red;">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Äî</span>
            {% endif %}
          </td>
          <td> <!-- ‡∏ä‡πà‡∏≠‡∏á2 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤(‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô) -->
            {{ record.total_units }} {{ product.unit }}
          </td>
          <td> <!-- ‡∏ä‡πà‡∏≠‡∏á3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ -->
            {% for detail in record.details %}
              {{ detail.sale_mode }} √ó {{ detail.quantity }} (‡∏£‡∏ß‡∏° {{ detail.total_units }} {{ product.unit }})<br>
            {% endfor %}
          </td>
          <td> <!-- ‡∏ä‡πà‡∏≠‡∏á4 ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏ä‡πà‡∏ô PO -->
            {% if record.evidence_image %}
            <a
              href="{{ url_for('static', filename='uploads/' ~ record.evidence_image) }}"
              target="_blank"
              >‡∏î‡∏π‡∏£‡∏π‡∏õ</a
            >
            {% else %}<span style="color: red">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>{% endif %}
          </td>
          <td>  <!-- ‡∏ä‡πà‡∏≠‡∏á5 ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
            {{ record.note or '' }}
          </td>
          <td class="manage-cell"> <!-- ‡∏ä‡πà‡∏≠‡∏á6 ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ -->
            <span
              class="edit-icon"
              onclick="openEditModal(
                {{ record.id }},
                '{{ record.date_in.strftime('%Y-%m-%d') if record.date_in else '' }}',
                `{{ record.note | default('') | e }}`
              )"
              >üõ†Ô∏è</span
            >
            <span class="delete-icon" onclick="confirmDelete('{{ record.id }}')">üóëÔ∏è</span>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" style="text-align: center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Modal -->
    <div id="editModal" class="modal">
      <div>
        <input type="hidden" id="editRecordId" />
        <label
          >‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: <input type="date" id="editDate" required /> </label
        ><br /><br />
        <label
          >‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:
          <div id="variant-edit-section">
            {% for variant in product.variants %}
              <label>
                {{ variant.sale_mode }} ({{ variant.pack_size }} {{ product.unit }}):
                <input
                  type="number"
                  class="edit-variant"
                  data-variant-id="{{ variant.id }}"
                  min="0"
                  value="0"
                />
              </label><br>
            {% endfor %}
          </div>
        <br /><br />
        <label
          >‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£):
          <input type="file" id="editEvidence" accept="image/*" /> </label
        ><br /><br />
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
        <br />
        <textarea
          id="editNote"
          rows="3"
          cols="40"
          placeholder="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
        ></textarea>
        <br /><br />
        <div id="editError" style="color: red"></div>
        <button type="button" onclick="submitEdit()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button type="button" onclick="closeEditModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <div id="deleteModal" class="modal">
      <div>
        <input type="hidden" id="recordIdInput" />
        <label>
          ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:
          <input type="password" id="passwordInput" required />
        </label>
        <br /><br />
        <div id="errorText" style="color: red"></div>
        <br />
        <button type="button" onclick="submitDelete()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button type="button" onclick="closeModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <script>

      function openEditModal(id, date, note) {
        document.getElementById("editRecordId").value = id;
        document.getElementById("editDate").value = date;
        document.getElementById("editNote").value = note || "";
        document.getElementById("editEvidence").value = "";
        document.getElementById("editError").innerText = "";
    
        // üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• quantity ‡πÅ‡∏ï‡πà‡∏•‡∏∞ variant ‡∏à‡∏≤‡∏Å backend
        fetch(`/stock_in/get_variant_qty/${id}`)
          .then((res) => res.json())
          .then((data) => {
            const variants = document.querySelectorAll(".edit-variant");
            variants.forEach((input) => {
              const variantId = input.dataset.variantId;
              input.value = data.quantities[variantId] || 0;
            });
          });
    
        document.getElementById("editModal").classList.add("show");
      }
      function closeEditModal() {
        document.getElementById("editModal").classList.remove("show");
        document.getElementById("editError").innerText = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      }
      function confirmDelete(id) {
        id = parseInt(id); // ‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
        document.getElementById("recordIdInput").value = id;
        document.getElementById("passwordInput").value = "";
        document.getElementById("errorText").innerText = "";
        document.getElementById("deleteModal").classList.add("show");
      }
      function closeModal() {
        document.getElementById("editModal").classList.remove("show");
        document.getElementById("deleteModal").classList.remove("show");
      }
      async function submitEdit() {
        const recordId = document.getElementById("editRecordId").value;
        const date = document.getElementById("editDate").value;
        const note = document.getElementById("editNote").value;
        const file = document.getElementById("editEvidence").files[0];
    
        const formData = new FormData();
        formData.append("date_in", date);
        formData.append("note", note);
        if (file) formData.append("evidence", file);
    
        // üîÅ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å variant
        const variants = document.querySelectorAll(".edit-variant");
        variants.forEach((input) => {
          const variantId = input.dataset.variantId;
          formData.append(`variant_${variantId}`, input.value);
        });
    
        const response = await fetch(`/stock_in/edit/${recordId}`, {
          method: "POST",
          body: formData,
        });
    
        const result = await response.json();
        if (result.success) {
          location.reload();
        } else {
          document.getElementById("editError").innerText =
            result.message || "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        }
      }
      async function submitDelete() {
        const recordId = document.getElementById("recordIdInput").value;
        const password = document.getElementById("passwordInput").value;
      
        const response = await fetch("/stock_in/delete/" + recordId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ password: password }),  // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á record_id ‡∏ã‡πâ‡∏≥
        });
      
        const result = await response.json();
      
        if (result.success) {
          location.reload();
        } else {
          document.getElementById("errorText").innerText =
            result.message || "‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        }
      }
  //script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á size ‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
  const allVariants = {{ variants_json | tojson }};
  let selectedVariantIds = new Set();

  function toggleSalesVariants() {
    const isChecked = document.getElementById("enableSalesVariants").checked;
    document.getElementById("sales-variants-section").style.display = isChecked ? "block" : "none";
    if (isChecked && document.getElementById("sales-variants-container").children.length === 0) {
      addSalesVariant();
    }
  }

  function toggleCustomStockin() {
    const checked = document.getElementById("enableCustomStockin").checked;
    document.getElementById("custom-stockin-section").style.display = checked ? "block" : "none";
  }

  function addSalesVariant() {
    const availableVariants = allVariants.filter(v => !selectedVariantIds.has(v.id));
    if (availableVariants.length === 0) {
      document.getElementById("add-sales-variant-btn").disabled = true;
      return;
    }
  
    const container = document.getElementById("sales-variants-container");
    const row = document.createElement("div");
    row.classList.add("sales-variant-row");
  
    const select = document.createElement("select");
    select.required = true;
    let previousValue = null;
  
    availableVariants.forEach((v, i) => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = `${v.sale_mode} (${v.pack_size})`;
      select.appendChild(opt);
  
      if (i === 0) {
        previousValue = v.id;
      }
    });
  
    select.value = previousValue;
    selectedVariantIds.add(previousValue);
  
    const quantity = document.createElement("input");
    quantity.type = "number";
    quantity.min = "1";
    quantity.placeholder = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô";
    quantity.required = true;
  
    select.name = "variant_id[]";
    quantity.name = "variant_qty[]";
  
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "‚ùå";
    removeBtn.onclick = function () {
      selectedVariantIds.delete(parseInt(select.value));
      row.remove();
      document.getElementById("add-sales-variant-btn").disabled = false;
    };
  
    select.onchange = function () {
      selectedVariantIds.delete(previousValue);
      const newValue = parseInt(this.value);
      selectedVariantIds.add(newValue);
      previousValue = newValue;
  
      document.getElementById("add-sales-variant-btn").disabled = selectedVariantIds.size >= allVariants.length;
    };
  
    row.appendChild(select);
    row.appendChild(quantity);
    row.appendChild(removeBtn);
    container.appendChild(row);
  
    if (selectedVariantIds.size >= allVariants.length) {
      document.getElementById("add-sales-variant-btn").disabled = true;
    }
  }
    </script>
  </body>
</html>
