<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <style>
      .modal {
        display: none;
        position: fixed;
        top: 45%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        padding: 1rem;
        border-radius: 10px;
        width: 400px;
        border: 1px solid #aaa;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 1;
        font-family: sans-serif;
      }
      .modal.show {
        display: block;
      }
      .manage-cell {
        position: relative;
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 400px;
      }
      .delete-icon {
        visibility: hidden;
        color: red;
        cursor: pointer;
      }
      .manage-cell:hover .delete-icon {
        visibility: visible;
      }
      .edit-icon {
        visibility: visible; /* üõ†Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î */
        cursor: pointer;
        color: #555;
        margin-right: 5px;
      }
      .report-icon {
        cursor: pointer;
        color: #007bff;
        margin-right: 5px;
        visibility: visible;
      } 
        #editCustomerTotal, 
        #editTransactionFee, 
        #editSellerReceive {
          display: none !important;
        }
    </style>
  </head>
  <body>
    <h1>‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ product.name }}</h1>

    <form method="post">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ):</label>
      <input
        type="datetime-local"
        name="date_sold"
        value="{{ current_datetime }}"
        required
      /><br /><br />
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
      <input type="text" name="customer_name" required />
      <br /><br />
      <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</label>
      <select name="channel" id="channel_select" onchange="updateFees()">
        {% for c in channels %}
        <option value="{{ c.channel }}">{{ c.channel }}</option>
        {% endfor %}
      </select>
      <a href="{{ url_for('manage_channels') }}">(‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</a>
      <br /><br />
      <!-- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
      <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</label>
      <input list="province_list" name="shipping_province" required placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" />
      <datalist id="province_list">
        <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£">
        <option value="‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà">
        <option value="‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ">
        <option value="‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô">
        <option value="‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤">
        <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">
        <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">
        <option value="‡∏£‡∏∞‡∏¢‡∏≠‡∏á">
        <option value="‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ">
        <option value="‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°">
      </datalist>
      <br /><br />
      <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</label>
      <select name="variant_id" id="newVariantId" onchange="updateNewUnitLabel()" required>
        {% for variant in product.variants if variant.is_for_sale %}
          <option value="{{ variant.id }}" data-sale-mode="{{ variant.sale_mode }}">
            {{ variant.sale_mode }} ({{ variant.pack_size }} {{ product.unit }})
          </option>
        {% endfor %}
      </select>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
      <input type="number" name="quantity" min="1" required>
      <label id="newUnitLabel">{{ product.unit }}</label>
      <br /><br />
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢:</label>
      <input type="number" name="price_per_unit" min="0" required>
      <label>‡∏ö‡∏≤‡∏ó</label>
      <br /><br />
      <!-- ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
      <label>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ä‡∏≥‡∏£‡∏∞):</label>
      <input type="number" name="shipping_fee" step="0.01" value="0.00" />
      <label>‡∏ö‡∏≤‡∏ó</label>
      <br /><br />
      <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î<span id="platformLabel">Shopee</span>:</label>
      <input type="number" name="platform_discount" step="0.01" value="0.00" />
      <label>‡∏ö‡∏≤‡∏ó</label>
      <br /><br />
      <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
      <input type="number" name="shop_discount" step="0.01"value="0.00"  />
      <label>‡∏ö‡∏≤‡∏ó</label>
      <br /><br />
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Coin -->
      <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Coin:</label>
      <input type="number" name="coin_discount" step="0.01" value="0.00" />
      <label>‡∏ö‡∏≤‡∏ó</label>
      <br /><br />
      <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </form>
    <br />
    <a href="{{ url_for('index') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <hr />
    <h2>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <form method="get">
      <label>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</label>
      <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}">
      -
      <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}">
    
      <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á:</label>
      <select name="channel">
        <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>
        {% for ch in channels %}
          <option value="{{ ch.channel }}" {% if request.args.get('channel') == ch.channel %}selected{% endif %}>{{ ch.channel }}</option>
        {% endfor %}
      </select>
    
      <button type="submit">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <a href="{{ url_for('sell_product', product_id=product.id) }}">‡∏£‡∏µ‡πÄ‡∏ã‡∏ï</a>
    </form>
    <br />
    <table border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th onclick="sortTable(0, this)">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</th>
          <th onclick="sortTable(1, this)">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
          <th onclick="sortTable(2, this)">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
          <th>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</th>
          <th onclick="sortTable(3, this)">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <!--<th onclick="sortTable(5, this)">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠{{product.unit}}</th>-->
          <th onclick="sortTable(6, this)">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
          <th onclick="sortTable(7, this)">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô</th>
          <th onclick="sortTable(8, this)">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Platform</th>
          <th onclick="sortTable(9, this)">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Coin</th>
          <!--<th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</th>-->
          <!--<th>‡∏Ñ‡πà‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</th>-->
          <th>‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞</th>
          <th>‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
          <!--<th>VAT</th>-->
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in sales_history %}
        <tr>
          <td>{{ sale.date_sold.strftime('%d/%m/%Y') }}</td>
          <td>{{ sale.customer_name }}</td>
          <td>{{ sale.channel}}</td>
          <td>{{ sale.variant.sale_mode }} ({{ sale.variant.pack_size }} {{ product.unit }})</td>
          <td>{{ sale.quantity }}</td>
          <td>{{ sale.variant.sale_mode }}</td>
          <!--<td>{{ '%.2f'|format(sale.sale_price) }}</td>-->
          {% set subtotal = (sale.quantity or 0) * (sale.sale_price or 0) %}
          <td>{{ '%.2f'|format(subtotal) }}</td>
          <td>{{ '%.2f'|format(sale.shop_discount or 0) }}</td>
          <td>{{ '%.2f'|format(sale.platform_discount or 0) }}</td>
          <td>{{ '%.2f'|format(sale.coin_discount or 0) }}</td>
          <!--<td>
            {{ "%.2f"|format(((sale.quantity * sale.sale_price * (sale.commission_percent or 0) / 100) | int)) }}
          </td>-->
          <!--<td>{{ '%.2f' | format(sale.transaction_fee) }}</td>-->
          <td>{{ '%.2f' | format(sale.customer_total) }}</td>
          <td>{{ '%.2f' | format(sale.seller_receive) }}</td>
          <!--<td>{{ '%.2f' | format(sale.vat_amount) }}</td>-->
          <td class="manage-cell">
            <span
            class="edit-icon"
            onclick="openEditModal(
              {{ sale.id }},
              '{{ sale.date_sold.strftime('%Y-%m-%dT%H:%M') }}',
              '{{ sale.customer_name|replace("'", "\\'") }}',
              {{ sale.quantity }},
              {{ sale.sale_price }},
              '{{ sale.channel|replace("'", "\\'") }}',
              {{ sale.shop_discount or 0 }},
              {{ sale.platform_discount or 0 }},
              '{{ sale.shipping_province or '' }}',
              {{ sale.coin_discount or 0 }},
              {{ sale.shipping_fee or 0 }},
              {{ sale.variant_id }}
            )"
          >üõ†Ô∏è</span>
            <a
            href="/sale/report/{{ sale.id }}"
            target="_blank"
            title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
            class="report-link"
            >üìä</a>
            <span class="delete-icon" onclick="confirmDelete({{ sale.id }})"
              >üóëÔ∏è</span
            >
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="12" style="text-align: center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div id="editModal" class="modal">
      <div>
        <input type="hidden" id="editSaleId" />
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</label>
        <input type="datetime-local" id="editDateSold" required /><br /><br />
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
        <input type="text" id="editCustomer" required /><br /><br />
        <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</label>
        <select id="editChannel" required>
          {% for ch in channels %}
          <option value="{{ ch.channel }}">{{ ch.channel }}</option>
          {% endfor %}</select
        ><br /><br />
        <!-- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</label>
        <input list="province_list" id="editProvince" required placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" />
        <datalist id="province_list">
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£">
          <option value="‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà">
          <option value="‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ">
          <option value="‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô">
          <option value="‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤">
          <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">
          <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">
          <option value="‡∏£‡∏∞‡∏¢‡∏≠‡∏á">
          <option value="‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ">
          <option value="‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°">
        </datalist>
        <br /><br />
        <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</label>
        <select id="editVariantId" required onchange="updateEditUnitLabel()">
          {% for variant in product.variants if variant.is_for_sale %}
          <option value="{{ variant.id }}"
                  data-sale-mode="{{ variant.sale_mode }}"
                  data-pack-size="{{ variant.pack_size }}">
              {{ variant.sale_mode }} ({{ variant.pack_size }} {{ product.unit }})
            </option>
          {% endfor %}
        </select>
        <br /><br />
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
        <input type="number" id="editQuantity" min="1" required />
        <label id="editUnitLabel">{{ product.unit }}</label>
        <br /><br />
        <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠{{product.unit}}:</label>
        <input type="number" step="0.01" id="editPricePerUnit" required />
        <label>‡∏ö‡∏≤‡∏ó</label>
        <br /><br />
        <!-- ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ä‡∏≥‡∏£‡∏∞) -->
        <label>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</label>
        <input type="number" step="0.01" id="editShippingFee" value="0.00" />
        <label>‡∏ö‡∏≤‡∏ó</label>
        <br /><br />
        <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Platform:</label>
        <input type="number" id="editPlatformDiscount" step="0.01" />
        <label>‡∏ö‡∏≤‡∏ó</label>
        <br /><br />
        <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
        <input type="number" id="editShopDiscount" step="0.01" />
        <label>‡∏ö‡∏≤‡∏ó</label>
        <br /><br />
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Coin -->
        <label>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Coin:</label>
        <input type="number" step="0.01" id="editCoinDiscount" value="0.00" />
        <label>‡∏ö‡∏≤‡∏ó</label>
        <br /><br />
        <div id="editError" style="color: red"></div>
        <button type="button" onclick="submitEdit()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button type="button" onclick="closeEditModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <div id="deleteModal" class="modal">
      <div>
        <input type="hidden" id="recordIdInput" />
        <label>
          ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:
          <input type="password" id="passwordInput" required />
        </label>
        <br /><br />
        <div id="errorText" style="color: red"></div>
        <br />
        <button type="button" onclick="submitDelete()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button type="button" onclick="closeModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <div id="reportModal" class="modal">
      <div>
        <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h3>
        <div id="reportContent">
          <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
        <br />
        <button type="button" onclick="closeReportModal()">‚ùå ‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
    <script>
      function openEditModal(
        id,
        dateSold,
        customerName,
        quantity,
        price,
        channel,
        shopDiscount = 0,
        platformDiscount = 0,
        shipping_province = '',
        coinDiscount = 0,
        shippingFee = 0,
        variantId
      ) {
        const dateObj = new Date(dateSold);
        const formattedDateTime = dateObj.toISOString().slice(0, 16); // ‡πÑ‡∏î‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DDTHH:mm
        document.getElementById("editDateSold").value = formattedDateTime;
        document.getElementById("editSaleId").value = id;
        document.getElementById("editCustomer").value = customerName;
        document.getElementById("editQuantity").value = quantity;
        document.getElementById("editPricePerUnit").value = price;
        document.getElementById("editChannel").value = channel;
        document.getElementById("editShopDiscount").value = shopDiscount;
        document.getElementById("editPlatformDiscount").value = platformDiscount;
        document.getElementById("editProvince").value = shipping_province;
        document.getElementById("editCoinDiscount").value = coinDiscount;
        document.getElementById("editShippingFee").value = shippingFee;
        document.getElementById("editModal").classList.add("show");
        document.getElementById("editVariantId").value = String(variantId);
        calculateEditSummary();
      }
      function closeModal() {
        document.getElementById("editModal").classList.remove("show");
        document.getElementById("deleteModal").classList.remove("show");
      }
      function closeEditModal() {
        document.getElementById("editModal").classList.remove("show");
        document.getElementById("deleteModal").classList.remove("show");
      }
      function confirmDelete(id) {
        document.getElementById("recordIdInput").value = id;
        document.getElementById("passwordInput").value = "";
        document.getElementById("errorText").innerText = "";
        document.getElementById("deleteModal").classList.add("show");
      }
      function calculateEditSummary() {
        const qty = parseFloat(document.getElementById("editQuantity").value) || 0;
        const price = parseFloat(document.getElementById("editPricePerUnit").value) || 0;
        const shipping = parseFloat(document.getElementById("editShippingFee").value) || 0;
        const shopDiscount = parseFloat(document.getElementById("editShopDiscount").value) || 0;
        const platformDiscount = parseFloat(document.getElementById("editPlatformDiscount").value) || 0;
        const coinDiscount = parseFloat(document.getElementById("editCoinDiscount").value) || 0;
      
        // 1. ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
        const totalPrice = qty * price;
        // 2. ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞
        const customerTotal = totalPrice - shopDiscount - platformDiscount - coinDiscount + shipping;
        // 3. ‡∏Ñ‡πà‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (‡∏õ‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
        const transactionFee = Math.round((customerTotal + platformDiscount + coinDiscount) * (transactionRate / 100));
        // 4. ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (‡∏õ‡∏±‡∏î‡∏•‡∏á)
        const commissionValue = Math.floor(totalPrice * (commissionRate / 100));
        // 5. ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
        const sellerReceive = totalPrice - commissionValue - transactionFee - shopDiscount;
        // 6. VAT
        const vat = ((commissionValue + transactionFee) * 7) / 107;
      
        // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô hidden input (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á preview)

        document.getElementById("editCustomerTotal").value = customerTotal.toFixed(2);
        document.getElementById("editTransactionFee").value = transactionFee.toFixed(2);
        document.getElementById("editSellerReceive").value = sellerReceive.toFixed(2);
      }
      const commissionRate = {{ commission or 0 }};        // ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
      const transactionRate = {{ transaction_fee or 0 }};  // ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå

      async function submitEdit() {
        const id = document.getElementById("editSaleId").value;
        const date_sold = document.getElementById("editDateSold").value;
        const customer_name = document.getElementById("editCustomer").value;
        const quantity = document.getElementById("editQuantity").value;
        const price = document.getElementById("editPricePerUnit").value;
        const channel = document.getElementById("editChannel").value;
        const shopDiscount = document.getElementById("editShopDiscount").value;
        const platformDiscount = document.getElementById(
          "editPlatformDiscount"
        ).value;
        const shippingProvince = document.getElementById("editProvince").value;
        const coinDiscount = document.getElementById("editCoinDiscount").value;
        const shippingFee = document.getElementById("editShippingFee").value;
        const qty = parseFloat(quantity) || 0;
        const prc = parseFloat(price) || 0;
        const shipping = parseFloat(shippingFee) || 0;
        const platformDisc = parseFloat(platformDiscount) || 0;
        const shopDisc = parseFloat(shopDiscount) || 0;
        const coinDisc = parseFloat(coinDiscount) || 0;
        const subtotal = qty * prc;
        const customerTotal = subtotal + shipping - platformDisc - shopDisc - coinDisc;
        
        const transactionFee = Math.round((customerTotal + platformDisc + coinDisc) * (transactionRate / 100));
        const sellerReceive = customerTotal - transactionFee;
        const variantId = document.getElementById("editVariantId").value;
        const formData = new FormData();
        formData.append("date_sold", date_sold);
        formData.append("customer_name", customer_name);
        formData.append("quantity", quantity);
        formData.append("price_per_unit", price);
        formData.append("channel", channel);
        formData.append("shop_discount", shopDiscount);
        formData.append("platform_discount", platformDiscount);
        formData.append("shipping_province", shippingProvince);
        formData.append("coin_discount", coinDiscount);
        formData.append("shipping_fee", shippingFee);
        formData.append("customer_total", customerTotal.toFixed(2));
        formData.append("fee_total", transactionFee.toFixed(2));  // ‚úÖ
        formData.append("seller_receive", sellerReceive.toFixed(2));
        formData.append("variant_id", variantId);

        const response = await fetch(`/sale/edit/${id}`, {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        if (result.success) {
          location.reload();
        } else {
          document.getElementById("editError").innerText =
            result.message || "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        }
      }
      async function submitDelete() {
        const id = document.getElementById("recordIdInput").value;
        const password = document.getElementById("passwordInput").value;

        const response = await fetch("/sale/delete/" + id, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ password: password }),
        });

        const result = await response.json();
        if (result.success) {
          location.reload();
        } else {
          document.getElementById("errorText").innerText =
            result.message || "‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        }
      }
      const quantityInput = document.querySelector('input[name="quantity"]');
      const priceInput = document.querySelector('input[name="price"]');
      const totalPriceInput = document.getElementById("totalPrice");

      function updateTotal() {
        const qty = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        totalPriceInput.value = (qty * price).toFixed(2);
      }
      quantityInput.addEventListener("input", updateTotal);
      priceInput.addEventListener("input", updateTotal);

      function updateFees() {
        const selectedChannel = document.getElementById("channel_select").value;
        const labelSpan = document.getElementById("platformLabel");
        if (labelSpan) {
          labelSpan.innerText = selectedChannel;
        }
      }

      function updateNewUnitLabel() {
        const select = document.getElementById('newVariantId');
        const selectedOption = select.options[select.selectedIndex];
        const saleMode = selectedOption.getAttribute('data-sale-mode');
      
        const label = document.getElementById('newUnitLabel');
        label.innerText = saleMode || '';
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î
      document.addEventListener('DOMContentLoaded', function () {
        updateNewUnitLabel();
      });
      
      function updateEditUnitLabel() {
        const select = document.getElementById('editVariantId');
        const selectedOption = select.options[select.selectedIndex];
        const saleMode = selectedOption.getAttribute('data-sale-mode');
      
        const unitLabel = document.getElementById('editUnitLabel');
        unitLabel.innerText = saleMode;  // ‡πÄ‡∏ä‡πà‡∏ô '‡πÅ‡∏û‡πá‡∏Ñ', '‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà'
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      document.addEventListener('DOMContentLoaded', function () {
        updateEditUnitLabel();
      });

      function openReportModal(saleId) {
        fetch(`/sale/report/${saleId}`)
          .then((response) => response.json())
          .then((data) => {
            const content = `
              <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${data.price.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${data.quantity} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
              <p><strong>‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î):</strong> ${(data.price * data.quantity).toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${data.shop_discount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Platform:</strong> ${data.platform_discount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Coins:</strong> ${data.coin_discount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ä‡∏≥‡∏£‡∏∞):</strong> ${data.shipping_fee.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${data.customer_total.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° Shopee (‡∏£‡∏ß‡∏° VAT):</strong> ${data.fee_total.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á:</strong> ${data.seller_receive.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
            `;
            document.getElementById("reportContent").innerHTML = content;
            document.getElementById("reportModal").classList.add("show");
          });
      }
      
      function closeReportModal() {
        document.getElementById("reportModal").classList.remove("show");
      }
    
      window.onload = updateFees;
      ["editQuantity", "editPricePerUnit", "editShippingFee", "editShopDiscount", "editPlatformDiscount", "editCoinDiscount"]
      .forEach(id => {
        document.getElementById(id).addEventListener("input", calculateEditSummary);
      });
      window.onload = function () {
        const now = new Date();
        const offset = now.getTimezoneOffset();
        const localDate = new Date(now.getTime() - offset * 60000);
        const isoString = localDate.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
        const input = document.getElementById("dateSoldInput");
        if (input && !input.value) {
          input.value = isoString;
        }
        updateFees(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
      };
      function sortTable(colIndex, thElement) {
        const table = document.querySelector("table");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll("tr"));
    
        // toggle direction
        const isAsc = table.dataset.sortColumn == colIndex && table.dataset.sortDirection !== "asc";
        table.dataset.sortColumn = colIndex;
        table.dataset.sortDirection = isAsc ? "asc" : "desc";
          
        // üîÅ ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏∏‡∏Å th
        document.querySelectorAll("th").forEach(th => {
          th.innerText = th.innerText.replace(/[\u25B2\u25BC]/g, '').trim(); // ‡πÄ‡∏≠‡∏≤ ‚ñ≤‚ñº ‡∏≠‡∏≠‡∏Å
        });
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ
        const arrow = isAsc ? " ‚ñ≤" : " ‚ñº";
        thElement.innerHTML = thElement.textContent.trim() + arrow;
    
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        rows.sort((a, b) => {
          const aText = a.cells[colIndex].textContent.trim();
          const bText = b.cells[colIndex].textContent.trim();
    
          let aVal = aText, bVal = bText;

          // üîÅ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 0
          if (colIndex === 0) {
            const parseDate = (d) => {
              const [day, month, year] = d.split("/");
              return new Date(`${year}-${month}-${day}`);
            };
            aVal = parseDate(aText);
            bVal = parseDate(bText);
          } else {
            // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            aVal = isNaN(aText) ? aText.toLowerCase() : parseFloat(aText);
            bVal = isNaN(bText) ? bText.toLowerCase() : parseFloat(bText);
          }
    
          if (aVal < bVal) return isAsc ? -1 : 1;
          if (aVal > bVal) return isAsc ? 1 : -1;
          return 0;
        });
        
        // ‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà
        rows.forEach(row => tbody.appendChild(row));
      }
    </script>
  </body>
</html>
