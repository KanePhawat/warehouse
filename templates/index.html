<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 60px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%; /* ‡πÄ‡∏î‡∏¥‡∏° 400px ‚Äî ‡πÉ‡∏´‡πâ responsive */
        max-width: 600px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î max */
        box-sizing: border-box;
        overflow-x: auto; /* ‡πÉ‡∏´‡πâ scroll ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô */
        border-radius: 8px;
      }
      .variant-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
      }
      .variant-row > * {
        flex: 1 1 120px; /* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î input ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö */
        min-width: 100px;
      }
      .delete-variant-btn {
        width: 100%;
        height: 100%;
        min-width: 32px;
        min-height: 32px;
        font-size: 16px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Lukfook üì¶</h1>
    <a href="{{ url_for('add_product') }}">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</a><br /><br />
    <table border="1" cellpadding="10">
      <thead>
        <tr>
          <th>‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th>SKU</th>
          <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
          <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
          <th>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %} {% set total_row = product.variants|length
        if product.variants else 1 %} {% for variant in
        product.variants|sort(attribute='pack_size') %}
        <tr>
          {% if loop.first %}
          <td rowspan="{{ total_row }}">
            {% if product.image_filename %}
            <img
              src="{{ url_for('static', filename='uploads/' + product.image_filename) }}"
              width="80"
            />
            {% else %}(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ){% endif %}
          </td>
          <td rowspan="{{ total_row }}">{{ product.name }}</td>
          {% endif %}
          <td>
            {{ product.sku }}{% if variant.sku_suffix %}-{{ variant.sku_suffix
            }}{% endif %}
          </td>
          {% if loop.first %}
          <td rowspan="{{ total_row }}">{{ product.category or '-' }}</td>
          <td rowspan="{{ total_row }}">{{ product.unit or '-' }}</td>
          {% endif %}
          <td>{{ variant.sale_mode }}</td>
          <td>{{ variant.pack_size }}</td>
          <td>
            {{ '{:,.2f}'.format(product.cost_price * variant.pack_size) }}
          </td>
          <td>
            {{ '{:,.2f}'.format(variant.selling_price) if variant.selling_price
            is not none else '‚Äì' }}
          </td>
          {% if loop.first %}
          <td rowspan="{{ total_row }}">{{ '{:,}'.format(product.stock) }}</td>
          {% endif %} {% if loop.first %}
          <!-- prettier-ignore -->
          <td rowspan="{{ total_row }}">
            <a
              href="#"
              class="edit-btn"
              data-id="{{ product.id }}"
              data-name="{{ product.name }}"
              data-sku="{{ product.sku }}"
              data-cost="{{ product.cost_price }}"
              data-category="{{ product.category or '' }}"
              data-unit="{{ product.unit or '' }}"
              data-variants='{{ product.serialized_variants | tojson | safe}}'
            >
              üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </a>
            <a href="#" class="delete-btn" data-id="{{ product.id }}">üóëÔ∏è ‡∏•‡∏ö</a>
            <a href="{{ url_for('stock_in', product_id=product.id) }}"
              >üìÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</a
            >
            |
            <a href="{{ url_for('sell_product', product_id=product.id) }}"
              >üì§ ‡∏Ç‡∏≤‡∏¢</a
            >
            <a href="{{ url_for('stock_movement', product_id=product.id) }}" class="btn btn-outline-info btn-sm">
              ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Stock
          </a>
          </td>
          {% endif %}
        </tr>
        {% endfor %} {% if products|length == 1 %}
        <tr>
          <td colspan="11" style="text-align: center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td>
        </tr>
        {% endif %} {% endfor %}
      </tbody>
    </table>

    <!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <form
          method="post"
          enctype="multipart/form-data"
          id="editForm"
          onsubmit="updateVariantCount()"
        >
          <h3>üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
          <label
            >‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:<br /><input
              type="text"
              name="name"
              id="edit_name"
              required /></label
          ><br /><br />
          <label
            >SKU:<br /><input
              type="text"
              name="sku"
              id="edit_sku"
              required /></label
          ><br /><br />
          <label
            >‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:<br /><input
              type="text"
              name="category"
              id="edit_category" /></label
          ><br /><br />
          <label
            >‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö:<br /><input
              type="text"
              name="unit"
              id="edit_unit" /></label
          ><br /><br />
          <label
            >‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:<br /><input
              type="number"
              name="cost_price"
              id="edit_cost_price"
              step="0.01"
              required /></label
          ><br />

          <div id="variant_section">
            <p>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>
            <div id="variant-container"></div>
            <button type="button" onclick="addVariantRow()">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
            </button>
          </div>

          <input type="hidden" name="variant_count" />

          <label
            >‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà:<br />
            <input type="file" name="image" accept="image/*" /> </label
          ><br /><br />

          <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button type="button" onclick="closeEditModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </form>
      </div>
    </div>
    <!-- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <input type="hidden" id="delete_product_id" />
        <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</p>
        <input type="password" id="delete_password" required />
        <p style="color: red; font-weight: bold">
          ‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏´‡∏≤‡∏Å‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
          ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏î‡πâ!
        </p>
        <div id="delete_error" style="color: red; font-weight: bold"></div>
        <button type="button" onclick="submitDelete()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button type="button" onclick="closeDeleteModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
    <script>
      function openEditModal(button) {
        const modal = document.getElementById("editModal");
        const form = document.getElementById("editForm");
        form.action = "/edit_product/" + button.dataset.id;
        document.getElementById("edit_name").value = button.dataset.name;
        document.getElementById("edit_sku").value = button.dataset.sku;
        document.getElementById("edit_cost_price").value = button.dataset.cost;
        document.getElementById("edit_category").value =
          button.dataset.category;
        document.getElementById("edit_unit").value = button.dataset.unit;

        let variants = JSON.parse(button.dataset.variants || "[]");
        variants.sort((a, b) => a.pack_size - b.pack_size); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å

        const container = document.getElementById("variant-container");
        container.innerHTML = "";

        if (variants.length === 0) {
          addVariantRow();
        } else {
          variants.forEach((v, i) => {
            const row = document.createElement("div");
            row.className = "variant-row";
            row.innerHTML = `
              <input type="text" name="variant_sale_mode_${i}" value="${
              v.sale_mode
            }" placeholder=‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢" />
              <input type="number" name="variant_pack_size_${i}" value="${
              v.pack_size
            }" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢" min="1" />
              <input type="number" name="variant_selling_price_${i}" value="${
              v.selling_price
            }" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" step="0.01" />
              <input type="text" name="variant_sku_suffix_${i}" value="${
              v.sku_suffix || ""
            }" placeholder="SKU ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢" />
              <button type="button" class="delete-variant-btn" onclick="removeVariantRow(this)">üóëÔ∏è</button>
            `;
            container.appendChild(row);
          });
        }
        updateVariantCount();
        reindexVariantRows();
        modal.style.display = "block";
      }

      function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function addVariantRow() {
        const container = document.getElementById("variant-container");
        const row = document.createElement("div");
        row.className = "variant-row";

        const index = container.children.length;

        row.innerHTML = `
          <input type="text" name="variant_sale_mode_${index}" placeholder="‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢" />
          <input type="number" name="variant_pack_size_${index}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢" min="1" />
          <input type="number" name="variant_selling_price_${index}" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" step="0.01" />
          <input type="text" name="variant_sku_suffix_${index}" placeholder="SKU ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢" />
          <button type="button" class="delete-variant-btn" onclick="removeVariantRow(this)">üóëÔ∏è</button>
        `;
        container.appendChild(row);
        updateVariantCount();
        reindexVariantRows();
      }

      function updateVariantCount() {
        const container = document.getElementById("variant-container");
        const form = document.getElementById("editForm");
        const countInput = form.querySelector("input[name='variant_count']");
        countInput.value = container.children.length;
      }

      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            openEditModal(btn);
          });
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const id = btn.dataset.id;
            confirmDelete(id);
          });
        });
      });

      function confirmDelete(id) {
        document.getElementById("delete_product_id").value = id;
        document.getElementById("delete_password").value = "";
        document.getElementById("delete_error").innerText = "";
        document.getElementById("deleteModal").style.display = "block";
      }
      function validateDeleteForm() {
        const password = document.getElementById("delete_password").value;
        if (!password) {
          document.getElementById("delete_error").innerText =
            "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
          return false;
        }
        return true;
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").style.display = "none";
      }

      function removeVariantRow(button) {
        const container = document.getElementById("variant-container");
        const rows = container.querySelectorAll(".variant-row");

        if (rows.length <= 1) {
          return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏•‡∏ö
        }

        button.parentElement.remove();
        updateVariantCount();
        reindexVariantRows();
      }

      function reindexVariantRows() {
        const container = document.getElementById("variant-container");
        const rows = container.querySelectorAll(".variant-row");

        rows.forEach((row, index) => {
          const select = row.querySelector("select");
          const inputs = row.querySelectorAll("input");
          const deleteBtn = row.querySelector(".delete-variant-btn");

          if (select) select.name = `variant_sale_mode_${index}`;
          if (inputs.length === 4) {
            inputs[0].name = `variant_sale_mode_${index}`;
            inputs[1].name = `variant_pack_size_${index}`;
            inputs[2].name = `variant_selling_price_${index}`;
            inputs[3].name = `variant_sku_suffix_${index}`;
          }

          // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ > 1 ‡πÅ‡∏ñ‡∏ß
          if (rows.length <= 1) {
            deleteBtn.style.display = "none";
          } else {
            deleteBtn.style.display = "inline-block";
          }
        });
      }
      async function submitDelete() {
        const productId = document.getElementById("delete_product_id").value;
        const password = document.getElementById("delete_password").value;

        const response = await fetch("/delete_product/" + productId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json", // üí• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
          },
          body: JSON.stringify({ password }), // üí• ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON string
        });

        try {
          const result = await response.json();

          if (result.success) {
            location.reload();
          } else {
            document.getElementById("delete_error").innerText = result.message;
          }
        } catch (error) {
          document.getElementById("delete_error").innerText =
            "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ";
          console.error("JSON parsing error:", error);
        }
      }
    </script>
  </body>
</html>
